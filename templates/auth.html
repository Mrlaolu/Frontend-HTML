{% extends "base.html" %}

{% block title %}登录 / 注册 · iCalligraphy{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="/static/css/auth.css" />
{% endblock %}

{% block content %}
    <main class="container auth-container">
      <div class="auth-card">
        <div class="auth-header">
          <h1 class="auth-title">欢迎来到 iCalligraphy</h1>
          <p class="auth-subtitle">探索中华书法艺术之美</p>
        </div>

        <!-- 登录/注册切换标签 -->
        <div class="auth-tabs">
          <button type="button" class="tab-btn active" data-tab="login">登录</button>
          <button type="button" class="tab-btn" data-tab="register">注册</button>
        </div>

        <!-- 登录表单 -->
        <div class="auth-form-container active" id="login-form">
          <!-- 登录方式切换 -->
          <div class="login-mode-switch">
            <button type="button" class="mode-btn active" data-mode="password">密码登录</button>
            <button type="button" class="mode-btn" data-mode="sms">验证码登录</button>
          </div>

          <!-- 密码登录 -->
          <form class="auth-form active" id="password-login-form">
            <div class="form-group">
              <label for="login-username">用户名 / 手机号 / 邮箱</label>
              <input type="text" id="login-username" name="username" placeholder="请输入用户名、手机号或邮箱" required autocomplete="username" />
            </div>
            <div class="form-group">
              <label for="login-password">密码</label>
              <div class="password-input-wrapper">
                <input type="password" id="login-password" name="password" placeholder="请输入密码" required autocomplete="current-password" />
                <button type="button" class="toggle-password" aria-label="显示密码">
                  <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                    <circle cx="12" cy="12" r="3"></circle>
                  </svg>
                </button>
              </div>
            </div>
            <div class="form-row">
              <label class="checkbox-label">
                <input type="checkbox" name="remember" />
                <span>记住我</span>
              </label>
              <a href="#" class="link-text">忘记密码？</a>
            </div>
            <button type="submit" class="btn btn-primary btn-full">登录</button>
          </form>

          <!-- 验证码登录 -->
          <form class="auth-form" id="sms-login-form">
            <div class="form-group">
              <label for="login-phone">手机号</label>
              <input type="tel" id="login-phone" name="phone" placeholder="请输入手机号" required pattern="[0-9]{11}" maxlength="11" />
            </div>
            <div class="form-group">
              <label for="login-sms-code">验证码</label>
              <div class="code-input-wrapper">
                <input type="text" id="login-sms-code" name="code" placeholder="请输入验证码" required maxlength="6" />
                <button type="button" class="btn-send-code">获取验证码</button>
              </div>
            </div>
            <button type="submit" class="btn btn-primary btn-full">登录</button>
          </form>

          <!-- 第三方登录 -->
          <div class="divider">
            <span>或使用第三方账号登录</span>
          </div>
          <div class="social-login">
            <button type="button" class="social-btn" aria-label="微信登录">
              <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                <path d="M8.5 10.5c-.8 0-1.5.7-1.5 1.5s.7 1.5 1.5 1.5 1.5-.7 1.5-1.5-.7-1.5-1.5-1.5zm7 0c-.8 0-1.5.7-1.5 1.5s.7 1.5 1.5 1.5 1.5-.7 1.5-1.5-.7-1.5-1.5-1.5z"/>
                <path d="M21.2 15.5c0-3.1-3.1-5.6-6.9-5.6s-6.9 2.5-6.9 5.6c0 2.8 2.4 5.1 5.6 5.5.8.2 1.3.6 1.5 1.1.1.4.1.9 0 1.3 0 0 0 .2.2.1.2 0 1.7-.9 2.5-1.6.9-.7 1.6-1.5 2.3-2.4.9-1 1.7-2.1 1.7-3.5z"/>
                <path d="M16.7 8.5c.4 0 .8 0 1.1.1C17.3 5.8 14.5 4 11.2 4 7.4 4 4 6.5 4 9.6c0 1.8 1 3.4 2.6 4.5.1.1.2.2.2.4 0 .3-.1.8-.2 1.1 0 0-.1.2.2.1.3-.1 2.1-1.2 3.2-2 .3-.2.6-.3.9-.2.5.1 1 .2 1.6.2 3.8 0 6.9-2.5 6.9-5.6 0-2.5-2-4.6-4.7-5.1z"/>
              </svg>
            </button>
            <button type="button" class="social-btn" aria-label="QQ登录">
              <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8 0-1.85.63-3.54 1.69-4.9.21.48.48.92.81 1.31C5.77 9.77 5.5 11.31 5.5 13c0 .83.67 1.5 1.5 1.5h10c.83 0 1.5-.67 1.5-1.5 0-1.69-.27-3.23-1-4.59.33-.39.6-.83.81-1.31C19.37 8.46 20 10.15 20 12c0 4.41-3.59 8-8 8z"/>
              </svg>
            </button>
            <button type="button" class="social-btn" aria-label="GitHub登录">
              <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                <path d="M12 2C6.477 2 2 6.477 2 12c0 4.42 2.865 8.17 6.839 9.49.5.092.682-.217.682-.482 0-.237-.008-.866-.013-1.7-2.782.603-3.369-1.34-3.369-1.34-.454-1.156-1.11-1.463-1.11-1.463-.908-.62.069-.608.069-.608 1.003.07 1.531 1.03 1.531 1.03.892 1.529 2.341 1.087 2.91.831.092-.646.35-1.086.636-1.336-2.22-.253-4.555-1.11-4.555-4.943 0-1.091.39-1.984 1.029-2.683-.103-.253-.446-1.27.098-2.647 0 0 .84-.269 2.75 1.025A9.578 9.578 0 0112 6.836c.85.004 1.705.114 2.504.336 1.909-1.294 2.747-1.025 2.747-1.025.546 1.377.203 2.394.1 2.647.64.699 1.028 1.592 1.028 2.683 0 3.842-2.339 4.687-4.566 4.935.359.309.678.919.678 1.852 0 1.336-.012 2.415-.012 2.743 0 .267.18.578.688.48C19.138 20.167 22 16.418 22 12c0-5.523-4.477-10-10-10z"/>
              </svg>
            </button>
          </div>
        </div>

        <!-- 注册表单 -->
        <div class="auth-form-container" id="register-form">
          <form class="auth-form active">
            <div class="form-group">
              <label for="reg-username">用户名</label>
              <input type="text" id="reg-username" name="username" placeholder="请输入用户名（3-20个字符）" required minlength="3" maxlength="20" autocomplete="username" />
            </div>
            <div class="form-group">
              <label for="reg-phone">手机号</label>
              <input type="tel" id="reg-phone" name="phone" placeholder="请输入手机号" required pattern="[0-9]{11}" maxlength="11" autocomplete="tel" />
            </div>
            <div class="form-group">
              <label for="reg-phone-code">验证码</label>
              <div class="code-input-wrapper">
                <input type="text" id="reg-phone-code" name="code" placeholder="请输入验证码" required maxlength="6" />
                <button type="button" class="btn-send-code">获取验证码</button>
              </div>
            </div>
            <div class="form-group">
              <label for="reg-email">邮箱（可选）</label>
              <input type="email" id="reg-email" name="email" placeholder="请输入邮箱地址" autocomplete="email" />
            </div>
            <div class="form-group">
              <label for="reg-password">密码</label>
              <div class="password-input-wrapper">
                <input type="password" id="reg-password" name="password" placeholder="请输入密码（至少6个字符）" required minlength="6" autocomplete="new-password" />
                <button type="button" class="toggle-password" aria-label="显示密码">
                  <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                    <circle cx="12" cy="12" r="3"></circle>
                  </svg>
                </button>
              </div>
            </div>
            <div class="form-group">
              <label for="reg-password-confirm">确认密码</label>
              <div class="password-input-wrapper">
                <input type="password" id="reg-password-confirm" name="password_confirm" placeholder="请再次输入密码" required autocomplete="new-password" />
                <button type="button" class="toggle-password" aria-label="显示密码">
                  <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                    <circle cx="12" cy="12" r="3"></circle>
                  </svg>
                </button>
              </div>
            </div>
            <div class="form-group">
              <label class="checkbox-label">
                <input type="checkbox" name="agree" required />
                <span>我已阅读并同意 <a href="#" class="link-text">用户协议</a> 和 <a href="#" class="link-text">隐私政策</a></span>
              </label>
            </div>
            <button type="submit" class="btn btn-primary btn-full">注册</button>
          </form>
        </div>
      </div>
    </main>
{% endblock %}

{% block footer_note %}{% endblock %}

{% block extra_js %}
<script defer>
  document.addEventListener('DOMContentLoaded', () => {
    // 密码登录表单提交
    const passwordLoginForm = document.getElementById('password-login-form');
    if (passwordLoginForm) {
      passwordLoginForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const username = document.getElementById('login-username').value.trim();
        const password = document.getElementById('login-password').value;
        const remember = document.querySelector('input[name="remember"]').checked;
        
        // 显示加载状态
        const submitBtn = passwordLoginForm.querySelector('button[type="submit"]');
        const originalText = submitBtn.textContent;
        submitBtn.disabled = true;
        submitBtn.textContent = '登录中...';
        
        try {
          // 调用登录API
          const response = await fetch('/api/auth/login', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({ username, password, remember })
          });
          
          const data = await response.json();
          
          if (response.ok) {
            // 保存凭据到authManager
            authManager.saveCredentials(data.access_token, data.refresh_token, data.user);
            
            // 强制页面刷新，确保导航栏更新
            window.location.href = '/';
          } else {
            alert(data.error || '登录失败，请重试');
          }
        } catch (error) {
          console.error('登录错误:', error);
          alert('网络错误，请稍后重试');
        } finally {
          // 恢复按钮状态
          submitBtn.disabled = false;
          submitBtn.textContent = originalText;
        }
      });
    }
    
    // 验证码登录表单提交
    const smsLoginForm = document.getElementById('sms-login-form');
    if (smsLoginForm) {
      smsLoginForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const phone = document.getElementById('login-phone').value.trim();
        const code = document.getElementById('login-sms-code').value.trim();
        
        // 显示加载状态
        const submitBtn = smsLoginForm.querySelector('button[type="submit"]');
        const originalText = submitBtn.textContent;
        submitBtn.disabled = true;
        submitBtn.textContent = '登录中...';
        
        try {
          // 调用登录API
          // 注意：验证码登录接口可能尚未实现，这里临时使用密码登录接口进行演示
          const response = await fetch('/api/auth/login', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({ username: phone, password: code }) // 临时方案：使用手机号作为用户名，验证码作为密码
          });
          
          const data = await response.json();
          
          if (response.ok) {
            // 保存凭据到authManager
            authManager.saveCredentials(data.access_token, data.refresh_token, data.user);
            
            // 强制页面刷新，确保导航栏更新
            window.location.href = '/';
          } else {
            alert(data.error || '登录失败，请重试');
          }
        } catch (error) {
          console.error('登录错误:', error);
          alert('网络错误，请稍后重试');
        } finally {
          // 恢复按钮状态
          submitBtn.disabled = false;
          submitBtn.textContent = originalText;
        }
      });
    }
    
    // 注册表单提交
    const registerForm = document.querySelector('#register-form .auth-form');
    if (registerForm) {
      registerForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const username = document.getElementById('reg-username').value.trim();
        const phone = document.getElementById('reg-phone').value.trim();
        const code = document.getElementById('reg-phone-code').value.trim();
        const email = document.getElementById('reg-email').value.trim();
        const password = document.getElementById('reg-password').value;
        const passwordConfirm = document.getElementById('reg-password-confirm').value;
        
        // 简单客户端验证
        if (password !== passwordConfirm) {
          alert('两次输入的密码不一致');
          return;
        }
        
        // 显示加载状态
        const submitBtn = registerForm.querySelector('button[type="submit"]');
        const originalText = submitBtn.textContent;
        submitBtn.disabled = true;
        submitBtn.textContent = '注册中...';
        
        try {
          // 调用注册API
          const response = await fetch('/api/auth/register', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({ username, phone, code, email, password })
          });
          
          const data = await response.json();
          
          if (data.success) {
            alert('注册成功！请登录');
            // 切换到登录标签
            document.querySelector('.tab-btn[data-tab="login"]').click();
          } else {
            alert(data.message || '注册失败，请重试');
          }
        } catch (error) {
          console.error('注册错误:', error);
          alert('网络错误，请稍后重试');
        } finally {
          // 恢复按钮状态
          submitBtn.disabled = false;
          submitBtn.textContent = originalText;
        }
      });
    }
    
    // 获取验证码按钮处理
    const sendCodeBtns = document.querySelectorAll('.btn-send-code');
    sendCodeBtns.forEach(btn => {
      btn.addEventListener('click', async () => {
        const form = btn.closest('form');
        const phoneInput = form.querySelector('input[type="tel"]');
        const phone = phoneInput.value.trim();
        
        if (!phone || !/^1[3-9]\d{9}$/.test(phone)) {
          alert('请输入正确的手机号');
          return;
        }
        
        // 禁用按钮并开始倒计时
        let countdown = 60;
        btn.disabled = true;
        btn.textContent = `${countdown}秒后重试`;
        
        try {
          // 调用发送验证码API
          const response = await fetch('/api/auth/send-code', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({ phone })
          });
          
          const data = await response.json();
          if (!data.success) {
            alert(data.message || '发送验证码失败');
            btn.disabled = false;
            btn.textContent = '获取验证码';
            return;
          }
        } catch (error) {
          console.error('发送验证码错误:', error);
          alert('网络错误，请稍后重试');
          btn.disabled = false;
          btn.textContent = '获取验证码';
          return;
        }
        
        // 倒计时
        const timer = setInterval(() => {
          countdown--;
          if (countdown > 0) {
            btn.textContent = `${countdown}秒后重试`;
          } else {
            clearInterval(timer);
            btn.disabled = false;
            btn.textContent = '获取验证码';
          }
        }, 1000);
      });
    });
  });
</script>
{% endblock %}